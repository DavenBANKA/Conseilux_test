{% extends "base.html" %}

{% block body_class %}dashboard-page{% endblock %}

{% block content %}
<section class="dashboard-section">
  <div class="container">
    <div class="dashboard-header">
      <h1>Welcome, {{ user.first_name }}!</h1>
      <p>Ready to test your English level?</p>
      <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
    </div>

    <div class="dashboard-content">
      <div class="test-card">
        <div class="test-icon">üìù</div>
        <h2>English Level Test</h2>
        <p>Complete Reading and Listening sections to get your CEFR level</p>
        
        <div class="test-info">
          <div class="info-item">
            <span class="icon">üìñ</span>
            <span>90 Reading Questions</span>
          </div>
          <div class="info-item">
            <span class="icon">üéß</span>
            <span>26 Listening Questions</span>
          </div>
          <div class="info-item">
            <span class="icon">‚è±Ô∏è</span>
            <span>~30 minutes total</span>
          </div>
        </div>

        <button id="start-test-btn" class="btn btn-primary btn-large">
          Start Test
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Resume Progress Modal -->
<div id="resume-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-icon">üîÑ</div>
    <h3 class="modal-title">Test in Progress</h3>
    <p class="modal-message" id="resume-message">
      You have an unfinished test. Would you like to continue where you left off?
    </p>
    <div class="modal-buttons">
      <button id="resume-restart" class="modal-btn modal-btn-secondary">Start Over</button>
      <button id="resume-continue" class="modal-btn modal-btn-primary">Continue</button>
    </div>
  </div>
</div>

<script>
let progressData = null;

// Check for existing progress on page load
window.addEventListener('DOMContentLoaded', async function() {
  try {
    const response = await fetch('/api/load_progress');
    const data = await response.json();
    
    if (data.success && data.has_progress && !data.progress.test_completed) {
      progressData = data.progress;
      showResumeModal();
    }
  } catch (error) {
    console.error('Error loading progress:', error);
  }
});

function showResumeModal() {
  const modal = document.getElementById('resume-modal');
  const message = document.getElementById('resume-message');
  
  // Update message with progress details
  const section = progressData.current_section === 'reading' ? 'Reading' : 'Listening';
  const question = progressData.current_question;
  
  message.textContent = `You were on ${section} section, question ${question}. Would you like to continue where you left off?`;
  
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function hideResumeModal() {
  const modal = document.getElementById('resume-modal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

// Start new test
document.getElementById('start-test-btn').addEventListener('click', function() {
  if (progressData && !progressData.test_completed) {
    showResumeModal();
  } else {
    window.location.href = '/test';
  }
});

// Continue from saved progress
document.getElementById('resume-continue').addEventListener('click', function() {
  hideResumeModal();
  
  // Redirect to appropriate section
  if (progressData.current_section === 'reading') {
    window.location.href = '/test';
  } else if (progressData.current_section === 'listening') {
    window.location.href = '/listening';
  }
});

// Restart test
document.getElementById('resume-restart').addEventListener('click', async function() {
  if (!confirm('Are you sure you want to start over? Your current progress will be lost.')) {
    return;
  }
  
  try {
    const response = await fetch('/api/reset_progress', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      hideResumeModal();
      window.location.href = '/test';
    }
  } catch (error) {
    console.error('Error resetting progress:', error);
    alert('An error occurred. Please try again.');
  }
});

// Close modal on outside click
document.getElementById('resume-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideResumeModal();
  }
});
</script>
{% endblock %}
